# Data Cleaning

## customer_orders table
- In the exclusions and extras columns, there are blank spaces and null values.

```sql
-- It is advised to not edit the Dataset directly but for this exercise, I would apply the change onto the Dataset.
-- For subsequence case study, I would create a temporary table instead
UPDATE customer_orders
SET
  exclusions = NULLIF(NULLIF(exclusions, ''), 'null'),
  extras = NULLIF(NULLIF(extras, ''), 'null')
;
```
#### Result set:

| order_id | customer_id | pizza_id | exclusions   | extras     | order_time          |
|----------|-------------|----------|--------------|------------|---------------------|
| 1        | 101         | 1        |              |            | 2020-01-01 18:05:02 |
| 2        | 101         | 1        |              |            | 2020-01-01 19:00:52 |
| 3        | 102         | 1        |              |            | 2020-01-02 23:51:23 |
| 3        | 102         | 2        |              |            | 2020-01-02 23:51:23 |
| 4        | 103         | 1        | 4            |            | 2020-01-04 13:23:46 |
| 4        | 103         | 1        | 4            |            | 2020-01-04 13:23:46 |
| 4        | 103         | 2        | 4            |            | 2020-01-04 13:23:46 |
| 5        | 104         | 1        |              | 1          | 2020-01-08 21:00:29 |
| 6        | 101         | 2        |              |            | 2020-01-08 21:03:13 |
| 7        | 105         | 2        |              | 1          | 2020-01-08 21:20:29 |
| 8        | 102         | 1        |              |            | 2020-01-09 23:54:33 |
| 9        | 103         | 1        | 4,           | 1, 5       | 2020-01-10 11:22:59 |
| 10       | 104         | 1        |              |            | 2020-01-11 18:34:49 |
| 10       | 104         | 1        | 2, 6         | 1, 4       | 2020-01-11 18:34:49 |

- The exclusions and extras columns in customer_orders table will need to be cleaned up before using them in the queries  

```sql
DROP TABLE IF EXISTS orders_sorted;

CREATE TEMPORARY TABLE orders_sorted
SELECT
  co.order_id,
  co.customer_id,
  co.pizza_number,
  co.pizza_id,
  TRIM(a.exclusions) AS exclusions, -- remove spaces
  TRIM(b.extras) AS extras, -- remove spaces
  co.order_time
FROM
  (
    SELECT
      *,
      ROW_NUMBER() OVER () AS pizza_number
    FROM
      customer_orders
  ) co
  JOIN json_table (
    TRIM(REPLACE(json_array (co.exclusions), ',', '","')),
    '$[*]' columns (exclusions VARCHAR(50) PATH '$')
  ) a
  JOIN json_table (
    TRIM(REPLACE(json_array (co.extras), ',', '","')),
    '$[*]' columns (extras VARCHAR(50) PATH '$')
  ) b
;
```
#### Result set:

| order_id | customer_id | pizza_number | pizza_id | exclusions   | extras     | order_time          |
|----------|-------------|--------------|----------|--------------|------------|---------------------|
| 1        | 101         | 1            | 1        |              |            | 2020-01-01 18:05:02 |
| 2        | 101         | 2            | 1        |              |            | 2020-01-01 19:00:52 |
| 3        | 102         | 3            | 1        |              |            | 2020-01-02 23:51:23 |
| 3        | 102         | 4            | 2        |              |            | 2020-01-02 23:51:23 |
| 4        | 103         | 5            | 1        | 4            |            | 2020-01-04 13:23:46 |
| 4        | 103         | 6            | 1        | 4            |            | 2020-01-04 13:23:46 |
| 4        | 103         | 7            | 2        | 4            |            | 2020-01-04 13:23:46 |
| 5        | 104         | 8            | 1        |              | 1          | 2020-01-08 21:00:29 |
| 6        | 101         | 9            | 2        |              |            | 2020-01-08 21:03:13 |
| 7        | 105         | 10           | 2        |              | 1          | 2020-01-08 21:20:29 |
| 8        | 102         | 11           | 1        |              |            | 2020-01-09 23:54:33 |
| 9        | 103         | 12           | 1        | 4            | 1          | 2020-01-10 11:22:59 |
| 9        | 103         | 12           | 1        | 4            | 5          | 2020-01-10 11:22:59 |
| 10       | 104         | 13           | 1        |              |            | 2020-01-11 18:34:49 |
| 10       | 104         | 14           | 1        | 2            | 1          | 2020-01-11 18:34:49 |
| 10       | 104         | 14           | 1        | 2            | 4          | 2020-01-11 18:34:49 |
| 10       | 104         | 14           | 1        | 6            | 1          | 2020-01-11 18:34:49 |
| 10       | 104         | 14           | 1        | 6            | 4          | 2020-01-11 18:34:49 |

***

## runner_orders table
- The pickup_time, distance, duration and cancellation columns in runner_orders table will need to be cleaned up before using them in the queries  
- In the pickup_time column, there are null values.
- In the distance column, there are null values. It contains unit - km. The 'km' must also be stripped 
- In the duration column, there are null values. The 'minutes', 'mins' 'minute' must be stripped
- In the cancellation column, there are blank spaces and null values.

```sql
UPDATE runner_orders
SET
  cancellation = NULLIF(cancellation, ''),
  duration = REGEXP_REPLACE(duration, '[^0-9]', ''),
  distance = REGEXP_REPLACE(distance, ' ?km', '')
;
```
#### Result set:

| order_id | runner_id | pickup_time         | distance | duration | cancellation             |
|----------|-----------|---------------------|----------|----------|--------------------------|
| 1        | 1         | 2020-01-01 18:15:34 | 20.0     | 32       |                          |
| 2        | 1         | 2020-01-01 19:10:54 | 20.0     | 27       |                          |
| 3        | 1         | 2020-01-03 00:12:37 | 13.4     | 20       |                          |
| 4        | 2         | 2020-01-04 13:53:03 | 23.4     | 40       |                          |
| 5        | 3         | 2020-01-08 21:10:57 | 10.0     | 15       |                          |
| 6        | 3         |                     |          |          | Restaurant Cancellation  |
| 7        | 2         | 2020-01-08 21:30:45 | 25.0     | 25       |                          |
| 8        | 2         | 2020-01-10 00:15:02 | 23.4     | 15       |                          |
| 9        | 2         |                     |          |          | Customer Cancellation    |
| 10       | 1         | 2020-01-11 18:50:20 | 10.0     | 10       |                          |

***

## pizza_recipes table
- The recipe of each pizza was combined into comma separated strings:

| pizza_id | toppings                  |
|----------|---------------------------|
| 1        | 1, 2, 3, 4, 5, 6, 8, 10   |
| 2        | 4, 6, 7, 9, 11, 12        |

- Lets split each topping into rows

```sql
CREATE TEMPORARY TABLE recipe_sorted
SELECT
  t.pizza_id,
  (j.topping)
FROM
  pizza_recipes t
  JOIN json_table (
    TRIM(REPLACE(json_array (t.toppings), ',', '","')),
    '$[*]' columns (topping VARCHAR(50) PATH '$')
  ) j 

```
#### Result set:

| pizza_id | topping |
|----------|---------|
| 1        | 1       |
| 1        | 2       |
| 1        | 3       |
| 1        | 4       |
| 1        | 5       |
| 1        | 6       |
| 1        | 8       |
| 1        | 10      |
| 2        | 4       |
| 2        | 6       |
| 2        | 7       |
| 2        | 9       |
| 2        | 11      |
| 2        | 12      |